<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.example.pool.service.impl.PoolManageMapper">
	
	<select id="selectReports" parameterType="poolManageVO" resultType="poolManageVO">
		with sub as (
			SELECT
				mstr.POLL_ID,
				GROUP_CONCAT(mstr.QESITM_SN order by FRST_REGISTER_PNTTM asc separator ",") as QESITM_SN,
				sub.POLL_STATUS
			FROM COMTNBBSPOOLATDRN mstr
			LEFT JOIN COMTNBBSPOOLMANAGE sub
			ON mstr.POLL_ID = sub.POLL_ID
			AND mstr.USER_ID = sub.USER_ID
			WHERE mstr.USER_ID = #{uniqId}
			GROUP BY mstr.POLL_ID
		)
		SELECT
			mstr.POLL_ID,
			sub2.POLL_NM,
			mstr.POLL_BGNDE as startDate,
			mstr.POLL_ENDDE as endDate,
			case when sub.POLL_STATUS is null then 'todo' else sub.POLL_STATUS end as status,
			case when cast(mstr.POLL_ENDDE as date) <![CDATA[<]]> now() then true else false end expired
		FROM COMTNBBSPOLL mstr
		LEFT JOIN sub
		ON mstr.POLL_ID = sub.POLL_ID
		LEFT JOIN COMTNBBSPOLL sub2
		ON mstr.POLL_ID = sub2.POLL_ID
		WHERE mstr.USE_AT = 'Y'
		ORDER BY mstr.POLL_ID
	</select>
	
	<select id="selectReportsTeacher" parameterType="poolManageVO" resultType="poolManageVO">
		select
			POLL_ID,
			POLL_NM,
			POLL_BGNDE as startDate,
			POLL_ENDDE as endDate,
			case when cast(POLL_ENDDE as date) <![CDATA[<]]> cast(now() as date) then true else false end as expired
		from COMTNBBSPOLL
	</select>
	
	<select id="selectReportsDtl" parameterType="poolManageVO" resultType="poolManageVO">
		with sub as (
			select
				mstr.POLL_ID,
				GROUP_CONCAT(concat(sub.QESITM_SN, ':', sub.QESITM_ANSWER, '/', sub.QUESITM_ANSWER_IMAGE) order by FRST_REGISTER_PNTTM asc separator ",") as QESITM_SN,
				mstr.QESITM_SN_LIST,
				mstr.POLL_STATUS
			from COMTNBBSPOOLMANAGE mstr
			left join COMTNBBSPOOLATDRN sub
			on mstr.POLL_ID = sub.POLL_ID
			and mstr.USER_ID = sub.USER_ID
			where mstr.USER_ID = #{uniqId}
			and mstr.POLL_ID = #{pollId}
			group by mstr.POLL_ID
		)
		select
			mstr.POLL_ID,
			mstr.POLL_NM,
			mstr.POLL_BGNDE as startDate,
			mstr.POLL_ENDDE as endDate,
			mstr.TEMP_SAVE as isSave,
			mstr.VOICE_SUP as isVoice, 
		 	case when sub.POLL_STATUS is null then 'todo' else sub.POLL_STATUS end as status,
		 	sub.QESITM_SN,
		 	sub.QESITM_SN_LIST
		from COMTNBBSPOLL mstr
		left join sub
		on mstr.POLL_ID = sub.POLL_ID
		where mstr.USE_AT = 'Y'
		and mstr.POLL_ID = #{pollId}
	</select>
	
	<select id="selectReportsQnA" parameterType="poolManageVO" resultType="poolManageVO">
		select
			a.POLL_ID as pollId,
			a.QESITM_SN as qesitmSn,
			a.QESITM_SJ as qesitmSj,
			a.QESITM_ANSWER_TEXT as qesitmAnswerText,
			a.QESITM_ANSWER_IMAGE as qesitmAnswerImage
		from COMTNBBSPOOLQESITM a
		where POLL_ID = #{pollId}
	</select>
	
	<insert id="insertReports" parameterType="poolManageVO">
		insert into COMTNBBSPOOLATDRN
		values (
			#{pollId},
			#{qesitmSn},
			#{qesitmAnswer},
			#{uniqId},
			now(),
			#{quesitmAnswerImage}
		)
	</insert>
	
	<insert id="insertReportsStatus" parameterType="poolManageVO">
		insert into COMTNBBSPOOLMANAGE
		values (
			#{uniqId},
			#{pollId},
			#{qesitmSnList},
			'progress'
		)
	</insert>
	
	<update id="updateReports" parameterType="poolManageVO">
		update  COMTNBBSPOOLATDRN
<<<<<<< HEAD
		set QESITM_ANSWER = #{qesitmAnswer}
		where USER_ID = #{uniqId}
		and POLL_ID = #{pollId}
=======
		set QESITM_ANSWER = #{qesitmAnswer},
			QUESITM_ANSWER_IMAGE = #{quesitmAnswerImage}
		where USER_ID = #{uniqId}
		and POLL_ID = #{pollId}
		and QESITM_SN = #{qesitmSn}
>>>>>>> aa94467fe4287c21531f8b86e748f60faab22b98
	</update>
	
	<update id="updateReportsStatus" parameterType="poolManageVO">
		update  COMTNBBSPOOLMANAGE
		set POLL_STATUS = 'done'
		where USER_ID = #{uniqId}
		and POLL_ID = #{pollId}
	</update>
	
	<select id="selectReportsCount" parameterType="poolManageVO" resultType="int">
		select
			count(*)
		from COMTNBBSPOOLQESITM mstr
		where mstr.POLL_ID = #{pollId}
	</select>
	
<<<<<<< HEAD
	<select id="selectIsDone" parameterType="poolManageVO" resultType="boolean">
		select
			case when count(*) > 0 then true else false end as isExist
=======
	<select id="selectIsDone" parameterType="poolManageVO" resultType="int">
		select
			case when count(*) > 0 then 1 else 0 end as isExist
>>>>>>> aa94467fe4287c21531f8b86e748f60faab22b98
		from COMTNBBSPOOLMANAGE a
		where a.USER_ID = #{uniqId}
		and a.POLL_ID = #{pollId}
		and a.POLL_STATUS = 'done'
	</select>	
	
	<select id="authorizationUser" parameterType="hashmap" resultType="boolean">
	    select
	        CASE 
	            WHEN count(*) > 0 THEN 1
	            ELSE 0
	        END as userExists
	    from COMTNMBER
	    where USER_ID = #{uniqId}
	</select>
	
<<<<<<< HEAD
	<select id="selectReportsNotice" parameterType="String" resultType="poolNoticeDTO">
	    select
			a.POLL_ID as pollId,
			a.POLL_NM as pollNm,
			a.POLL_BGNDE as startDate,
			a.POLL_ENDDE as endDate,
<<<<<<< HEAD
			case when cast(POLL_ENDDE as date) <![CDATA[<]]> cast(now() as date) then true else false end as expired
	    from COMTNBBSPOOLATDRN
	    where POLL_ID = #{pollId}
=======
	<select id="selectHistoryIsExist" parameterType="hashmap" resultType="boolean">
		select
			case when count(*) > 0 then true else false end as isExist
=======
			case when cast(POLL_ENDDE as date) <![CDATA[<]]> cast(now() as date) then 1 else 0 end as expired
		from COMTNBBSPOLL a
	    where a.POLL_ID = #{pollId}
	</select>
	
	<select id="selectHistoryIsExist" parameterType="hashmap" resultType="int">
		select
			case when count(*) > 0 then 1 else 0 end as isExist
>>>>>>> aa94467fe4287c21531f8b86e748f60faab22b98
		from COMTNBBSPOOLATDRN a
		where a.USER_ID = #{uniqId}
		and a.POLL_ID = #{pollId}
		and QESITM_SN = #{qesitmSn}
	</select>
	
<<<<<<< HEAD
	<select id="selectReportsMngIsExist" parameterType="hashmap" resultType="boolean">
		select
			case when count(*) > 0 then true else false end as isExist
		from COMTNBBSPOOLMANAGE a
		where a.USER_ID = #{uniqId}
		and a.POLL_ID = #{pollId}
>>>>>>> 4e51add98f20e28593e059b92489a983eb8d1528
=======
	<select id="selectReportsMngIsExist" parameterType="hashmap" resultType="int">
		select
			case when count(*) > 0 then 1 else 0 end as isExist
		from COMTNBBSPOOLMANAGE a
		where a.USER_ID = #{uniqId}
		and a.POLL_ID = #{pollId}
>>>>>>> aa94467fe4287c21531f8b86e748f60faab22b98
	</select>
</mapper>